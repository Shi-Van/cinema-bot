# Shven cinema (@cool_cinema_search_bot)

Телеграм-бот для поиска информации о фильмах и сериалах с помощью неофициального API Кинопоиска.

## Функциональность

### Основные команды
- `/start` - начало работы с ботом
- `/help` - справка по использованию бота
- `/history` - история поиска пользователя
- `/stats` - статистика поиска по фильмам

### Поиск фильмов
Бот ищет фильмы по любому текстовому запросу. Просто отправьте название фильма или сериала, и бот найдет подходящие варианты.

Примеры запросов:
- Venom
- остров собак
- магия лунного света
- Мстители: война бесконечности
- город в котором меня нет
- как витька чеснок вез леху штыря в дом инвалидов

### Информация о фильме
Для каждого фильма бот показывает:
- Название (оригинальное и русское)
- Год выпуска
- Длительность
- Возрастной рейтинг
- Рейтинг Кинопоиска (с количеством голосов)
- Жанры
- Страны производства
- Описание фильма
- Постер (если доступен)
- Ссылки на просмотр и дополнительные ресурсы (Кинопоиск, IMDB)

### История и статистика
- `/history` показывает последние поиски пользователя с возможностью пагинации
- `/stats` отображает статистику по фильмам: сколько раз каждый фильм был найден, средний рейтинг

## Технические детали

### Используемые технологии
- **Python 3.11+**
- **aiogram 3.x** - для работы с Telegram API
- **aiohttp** - для асинхронных HTTP-запросов
- **SQLAlchemy** - для работы с базой данных
- **SQLite** - в качестве базы данных

### API
- **Кинопоиск неофициальное API https://kinopoisk.dev/** - для получения информации о фильмах
- **aiogram** - для взаимодействия с пользователями

### Структура проекта
```
cinemabot/
├── app/
│   ├── db/
│   │   ├── database.py  # Работа с БД
│   │   └── models.py    # Модели данных
│   ├── utils/
│   │   └── text_loader.py  # Загрузка текстовых сообщений
│   ├── bot.py          # Основная логика бота
│   ├── config.py       # Конфигурация
│   ├── kinopoisk_api.py # Работа с API Кинопоиска
│   └── main.py         # Точка входа
├── texts/              # Текстовые файлы для сообщений
├── .env               # Переменные окружения
└── requirements.txt   # Зависимости
```

### Архитектура и основные классы

#### Модели данных (`app/db/models.py`)
- `Base` - базовый класс для моделей SQLAlchemy
- `User` - модель пользователя:
  - Хранит telegram_id и username
  - Связь один-ко-многим с историей поиска
- `SearchHistory` - модель истории поиска:
  - Содержит информацию о запросе и найденном фильме
  - Связь с пользователем
  - Хранит рейтинг и ссылки

#### Работа с БД (`app/db/database.py`)
- `Database` - основной класс для работы с базой данных:
  - Асинхронная инициализация БД
  - Методы для работы с пользователями (создание, поиск)
  - Методы для работы с историей поиска
  - Методы для получения статистики и истории с пагинацией

#### API Кинопоиска (`app/kinopoisk_api.py`)
- `MovieInfo` - датакласс для хранения информации о фильме:
  - Основные поля (название, год, рейтинг и т.д.)
  - Ссылки на постеры и ресурсы
- `KinopoiskAPI` - класс для работы с API:
  - Асинхронный поиск фильмов
  - Получение детальной информации о фильме
  - Обработка ответов API

#### Основной класс бота (`app/bot.py`)
- `CinemaBot` - основной класс бота:
  - Инициализация компонентов (бот, диспетчер, БД, API)
  - Регистрация обработчиков команд
  - Обработка поисковых запросов
  - Форматирование сообщений
  - Работа с инлайн-кнопками
  - Пагинация для истории и статистики

#### Конфигурация (`app/config.py`)
- `Settings` - класс настроек на основе Pydantic:
  - Загрузка переменных окружения
  - Валидация обязательных параметров
  - Настройки логирования и БД

#### Точка входа (`app/main.py`)
- Инициализация логгера
- Создание и запуск бота
- Обработка асинхронных операций

### Особенности реализации
1. **Асинхронность**: все сетевые запросы и операции с БД выполняются асинхронно
2. **Пагинация**: история и статистика поддерживают постраничный просмотр
3. **Кэширование**: настройки загружаются с помощью `lru_cache`
4. **Безопасность**: все токены и секреты хранятся в переменных окружения
5. **Логирование**: подробное логирование всех операций

### Дополнительные возможности
- Поддержка HTML-форматирования в сообщениях
- Цитирование описания фильма
- Отображение количества голосов за фильм
- Разделение фильмов и сериалов (специальная метка)
- Сохранение полной истории поиска с возможностью просмотра
- Статистика по популярности фильмов среди пользователей